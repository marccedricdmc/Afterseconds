"use client";
import React, { useState, useRef, useEffect } from 'react';

export default function AfterSecondsBooth() {
  const [step, setStep] = useState(1);
  const [layout, setLayout] = useState('A'); 
  const [timer, setTimer] = useState(10);
  const [photos, setPhotos] = useState<string[]>([]);
  const [isPreparing, setIsPreparing] = useState(true);
  const [stripColor, setStripColor] = useState('#000000'); 
  const [filter, setFilter] = useState('none'); 
  const [customText, setCustomText] = useState('');
  const [retakeIndices, setRetakeIndices] = useState<number[]>([]);
  const [currentDate] = useState(new Date().toLocaleDateString('en-GB').replace(/\//g, '.'));
  
  const videoRef = useRef<HTMLVideoElement>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const offscreenCanvasRef = useRef<HTMLCanvasElement>(null);

  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://afterseconds.com`;

  const startSession = (selectedLayout: string) => {
    setPhotos([]); 
    setRetakeIndices([]);
    setLayout(selectedLayout);
    setTimer(10); 
    setIsPreparing(true);
    setStep(3);
    startCamera();
  };

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      if (videoRef.current) videoRef.current.srcObject = stream;
    } catch (err) { console.error("Camera error:", err); }
  };

  useEffect(() => {
    let interval: any;
    if (step === 3 && timer > 0) {
      interval = setInterval(() => setTimer(prev => prev - 1), 1000);
    } else if (step === 3 && timer === 0) {
      if (isPreparing) {
        setIsPreparing(false);
        setTimer(4); 
      } else {
        capturePhoto();
      }
    }
    return () => clearInterval(interval);
  }, [step, timer, isPreparing]);

  const capturePhoto = () => {
    const maxShots = layout === 'A' ? 4 : 6;
    if (videoRef.current && canvasRef.current) {
      const context = canvasRef.current.getContext('2d');
      if (context) {
        context.drawImage(videoRef.current, 0, 0, 640, 480);
        const data = canvasRef.current.toDataURL('image/png');
        setPhotos(prev => {
          let updated = [...prev];
          if (retakeIndices.length > 0) {
            const targetIndex = retakeIndices[0];
            updated[targetIndex] = data; 
            const remaining = retakeIndices.slice(1);
            setRetakeIndices(remaining);
            if (remaining.length > 0) { setTimer(4); return updated; } 
            else { setStep(4); return updated; }
          } 
          updated.push(data);
          if (updated.length < maxShots) { setTimer(4); } else { setStep(4); }
          return updated;
        });
      }
    }
  };

  const downloadPhotostrip = async () => {
    const canvas = offscreenCanvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Perfect 4R fit: 1200x1800
    canvas.width = 1200;
    canvas.height = 1800;
    ctx.fillStyle = stripColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const photosPerStrip = layout === 'A' ? 2 : 3;
    const stripWidth = canvas.width / 2;

    const loadImg = (src: string): Promise<HTMLImageElement> => 
      new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = src;
        img.onload = () => resolve(img);
      });

    const qrImg = await loadImg(qrUrl);

    for (const stripIndex of [0, 1]) {
      const xOffset = stripIndex * stripWidth;
      const startIdx = stripIndex * photosPerStrip;

      ctx.fillStyle = "white";
      ctx.font = "italic 55px serif"; 
      ctx.textAlign = "left";
      ctx.fillText("After Seconds", xOffset + 50, 110);
      ctx.drawImage(qrImg, xOffset + stripWidth - 110, 50, 70, 70);

      const photoW = stripWidth - 100;
      const photoH = layout === 'A' ? 650 : 440;
      
      for (let i = 0; i < photosPerStrip; i++) {
        const photoData = photos[startIdx + i];
        if (photoData) {
          const pImg = await loadImg(photoData);
          if (filter === 'bnw') ctx.filter = 'grayscale(100%)';
          if (filter === 'vibrant') ctx.filter = 'saturate(150%) contrast(110%)';
          ctx.drawImage(pImg, xOffset + 50, 200 + (i * (photoH + 40)), photoW, photoH);
          ctx.filter = 'none';
        }
      }

      ctx.fillStyle = "white";
      ctx.textAlign = "center";
      ctx.font = "bold 34px sans-serif";
      ctx.fillText(customText.toUpperCase(), xOffset + (stripWidth / 2), canvas.height - 120);
      ctx.font = "20px monospace";
      ctx.fillText(`${currentDate}   AFTER SECONDS`, xOffset + (stripWidth / 2), canvas.height - 60);
    }

    canvas.toBlob((blob) => {
      if (blob) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = `AfterSeconds_4R.png`;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
      }
    }, 'image/png');
  };

  const Full4RLayout = ({ poses }: { poses: string[] }) => {
    const fStyle = filter === 'vibrant' ? 'saturate(1.5) contrast(1.1)' : filter === 'bnw' ? 'grayscale(1)' : 'none';
    const photosPerStrip = layout === 'A' ? 2 : 3;

    return (
      <div className="w-[420px] aspect-[4/6] flex relative overflow-hidden shadow-2xl rounded-sm" style={{ backgroundColor: stripColor }}>
        {[0, 1].map(stripIdx => (
          <div key={stripIdx} className="flex-1 flex flex-col p-5">
            <div className="flex justify-between items-start mb-6">
               <div className="text-white font-serif italic text-xl">After Seconds</div>
               <img src={qrUrl} className="w-8 h-8 bg-white p-[1px]" alt="QR" />
            </div>
            <div className="flex flex-col gap-3">
              {Array.from({ length: photosPerStrip }).map((_, i) => {
                const idx = (stripIdx * photosPerStrip) + i;
                return (
                  <div key={idx} className="bg-zinc-800 aspect-[4/3] relative border-2 border-transparent">
                    {poses[idx] && <img src={poses[idx]} style={{ filter: fStyle }} className="w-full h-full object-cover scale-x-[-1]" />}
                  </div>
                );
              })}
            </div>
            <div className="mt-auto text-center pt-4">
               <p className="text-white font-black text-[10px] uppercase mb-1">{customText}</p>
               <div className="flex justify-between items-center text-[7px] text-white/60 font-mono">
                <span>{currentDate}</span>
                <span className="italic font-serif">After Seconds</span>
               </div>
            </div>
          </div>
        ))}
        <div className="absolute left-1/2 top-0 bottom-0 w-[1px] bg-white/20 border-l border-dashed" />
      </div>
    );
  };

  return (
    <main className="flex min-h-screen items-center justify-center bg-[#690F0F] text-[#D9D9D9] p-6">
      <canvas ref={canvasRef} width="640" height="480" className="hidden" />
      <canvas ref={offscreenCanvasRef} className="hidden" />

      {step === 1 && (
        <button onClick={() => setStep(2)} className="bg-[#D9D9D9] text-[#690F0F] text-3xl font-black py-6 px-20 rounded-full uppercase">Tap to Start</button>
      )}

      {step === 2 && (
        <div className="flex flex-col items-center">
          <h2 className="text-4xl font-black mb-16 italic uppercase">Select Layout</h2>
          <div className="flex gap-20">
            {['A', 'B'].map(l => (
              <div key={l} className="cursor-pointer text-center" onClick={() => startSession(l)}>
                <div className="scale-[0.4] origin-top"><Full4RLayout poses={[]} /></div>
                <div className="bg-white text-black py-4 px-10 rounded-full font-black uppercase -mt-20">Layout {l}</div>
              </div>
            ))}
          </div>
        </div>
      )}

      {step === 3 && (
        <div className="relative w-full h-screen bg-black flex items-center justify-center overflow-hidden">
          <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover scale-x-[-1]" />
          <div className="absolute right-12 top-1/2 -translate-y-1/2 scale-[0.45] origin-right z-20 opacity-90">
             <Full4RLayout poses={photos} />
          </div>
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[15rem] font-black text-white">{timer}</div>
        </div>
      )}

      {step === 4 && (
        <div className="flex gap-12 items-center">
          <Full4RLayout poses={photos} />
          <div className="bg-[#D9D9D9] p-10 rounded-[3rem] text-[#690F0F] flex flex-col gap-6 shadow-2xl w-[400px]">
            <h3 className="font-black uppercase text-xl italic border-b border-[#690F0F]/10 pb-4">Settings</h3>
            <div className="flex gap-3">
              {['#000000', '#690F0F', '#FFFFFF', '#E6C9C9', '#F4C2C2'].map(c => (
                <button key={c} onClick={() => setStripColor(c)} className={`w-10 h-10 rounded-full border-2 ${stripColor === c ? 'border-[#690F0F]' : 'border-transparent'}`} style={{ backgroundColor: c }} />
              ))}
            </div>
            <div className="grid grid-cols-3 gap-2">
              {['none', 'vibrant', 'bnw'].map(f => (
                <button key={f} onClick={() => setFilter(f)} className={`py-3 rounded-xl font-bold uppercase text-[10px] border-2 ${filter === f ? 'bg-[#690F0F] text-white' : 'border-[#690F0F]'}`}>{f}</button>
              ))}
            </div>
            <input type="text" maxLength={20} className="p-4 rounded-xl border-2 font-bold uppercase text-center" placeholder="MESSAGE" onChange={(e) => setCustomText(e.target.value)} />
            <div className="flex flex-col gap-4">
              <button onClick={downloadPhotostrip} className="bg-[#690F0F] text-white py-6 rounded-2xl font-black uppercase shadow-xl tracking-widest">Download 4R Strip</button>
              <button onClick={() => { setPhotos([]); setStep(1); }} className="text-xs font-bold uppercase text-center opacity-60">Reset</button>
            </div>
          </div>
        </div>
      )}
    </main>
  );
}
